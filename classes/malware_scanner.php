<?php

class malCure_Malware_Scanner extends malCure_Scanner {

	static function get_instance() {
		static $instance = null;
		if ( is_null( $instance ) ) {
			$instance = new self();
			$instance->init();
		}
		return $instance;
	}

	private function __construct() {
	}

	function init() {
		add_action( 'wp_ajax_mss_update_definitions', array( $this, 'mss_update_definitions' ) );
		add_action( 'wp_ajax_nopriv_mss_update_definitions', '__return_false' );
		add_action( 'wp_ajax_mss_trigger_scan', array( $this, 'mss_trigger_scan' ) );
		add_action( 'wp_ajax_nopriv_mss_trigger_scan', 'mss_trigger_scan' );
		add_action( 'wp_ajax_mss_init_scan', array( $this, 'mss_init_scan_responder' ) );
		add_action( 'wp_ajax_nopriv_mss_init_scan', array( $this, 'mss_init_scan_responder' ) );
		add_action( 'wp_ajax_mss_scan_request', array( $this, 'scan_responder' ) );
		add_action( 'wp_ajax_nopriv_mss_scan_request', array( $this, 'scan_responder' ) );
		add_action( 'wp_ajax_mss_scan_status', array( $this, 'mss_scan_status_handler' ) );
		add_action( 'wp_ajax_nopriv_mss_scan_status', '__return_false' );
		add_action( 'upgrader_process_complete', array( $this, 'delete_checksums' ), 9999, 2 );
		add_action( 'malCure_security_suite_add_meta_boxes', array( $this, 'add_meta_boxes' ) );

		add_action( 'wp', array( $this, 'trigger_maintenance' ) );  }

	function trigger_maintenance() {
		malCure_Utils::flog( __FUNCTION__ );
		malCure_Utils::do_maintenance();
	}

	function options_debug( $option, $old_value, $value ) {
		if ( $option == 'MSS' ) {
			malCure_Utils::flog( 'NEW:' );
			if ( empty( $value['scan'] ) ) {
				malCure_Utils::flog( 'Received empty value for scan' );
				malCure_Utils::flog( debug_backtrace() );
				return;
			} else {
				malCure_Utils::flog( $value['scan'] );
			}
		}
	}

	function delete_checksums() {
		malCure_Utils::delete_option_checksums_core();
	}

	function add_meta_boxes() {
		add_meta_box( 'malcure_scanner', 'Malware Scanner', array( $this, 'scanner_meta_box' ), $GLOBALS['malCure_security_suite']['pagehook'], 'main' );
	}

	function mss_update_definitions() {
		if ( malCure_Utils::is_registered() ) {
			malCure_Utils::update_definitions();
			wp_send_json_success();
		} else {
			wp_send_json_error( 'unregistered' );
		}
	}

	function scanner_meta_box() {
		$defs = malCure_Utils::get_option_definitions();
		if ( empty( $defs ) ) {
			echo '<p>You need to update definitions before you can scan.</p>';
			submit_button( 'Update Definitions', 'primary', 'mss_update_definitions_btn' );
			echo '<div id="defs_action_response"></div>';
		} else {
			submit_button( 'Scan', 'primary', 'mss_scan_btn' );
			echo '<div id="scan_progress"></div>';
			echo '<div id="scan_results"></div>';
		}
		?>
		<script type="text/javascript">
			jQuery(document).ready(function($){
				$("#mss_update_definitions_btn").click(function(){
					mss_update_definitions = {
						mss_update_definitions_nonce: '<?php echo wp_create_nonce( 'mss_update_definitions_scan' ); ?>',
						action: "mss_update_definitions",
					};
					$.ajax({
						url: ajaxurl,
						method: 'POST',
						data: mss_update_definitions,
						success: function(data, textStatus, jqXHR) {
							if ((typeof data) != 'object') {
								$('#defs_action_response').html('<p>Invalid response.</p>');
							}
							if (data.hasOwnProperty('success')) {
								$('#defs_action_response').html('<p>Updated Definitions.</p>');
							} else {
								$('#defs_action_response').html('<p>Request failed.</p>');
							}
						},
						error: function( jqXHR, textStatus, errorThrown){
							$('#defs_action_response').html('<p>Request error.</p>');
						},
						complete: function(jqXHR_data, textStatus) {							
						},
					});
				});
				$("#mss_scan_btn").click(function(){
					mss_trigger_scan = {
						mss_trigger_scan_nonce: '<?php echo wp_create_nonce( 'mss_trigger_scan' ); ?>',
						action: "mss_trigger_scan",
					};
					$.ajax({
						url: ajaxurl,
						method: 'POST',
						data: mss_trigger_scan,
						success: function(data, textStatus, jqXHR) {
							console.dir('success Data Begins');
							console.dir(data);
							console.dir(textStatus);
							console.dir(jqXHR);
							console.dir('success Data Ends');
							mss_status_updater = setTimeout(mss_update_scan_status,1000);
							if ((typeof data) != 'object') {								
							}
							if (data.hasOwnProperty('success')) {								
							} else {								
							}
						},
						error: function( jqXHR, textStatus, errorThrown){},
						complete: function(jqXHR_data, textStatus) {},
					});
				});
				mss_status_updater = setTimeout(mss_update_scan_status,1000);
			});

			function mss_update_scan_status() {
			var $ = jQuery.noConflict();
			mss_scan_status = {
				mss_scan_status_nonce: '<?php echo wp_create_nonce( 'mss_scan_status' ); ?>',
				action: "mss_scan_status",
			};
			$.ajax({
				url: ajaxurl,
				method: 'POST',
				data: mss_scan_status,
				success: function (data, textStatus, jqXHR) {
					console.dir(data);
					if (data.success) {
						if (data.data) {
							$('#scan_progress').addClass('inprogress');
							if (data.data.total) {
								remaining = parseInt(data.data.remaining);
								total = parseInt(data.data.total);
								done = total - remaining;
								per = (done / total) * 100;
								per_done = per;
								started = parseInt(data.data.started);
								now = parseInt(data.data.now);
								secs = now - started;
								console.log(per_done.toFixed(1) + '% ' + done + '/' + data.data.total + ' @ ' + Math.round(done / secs) + ' Files / Sec');
								$('#scan_progress').css('background', 'linear-gradient(90deg, #00bfe6 0%, #00bfe6 ' + per_done + '%, transparent ' + per_done + '%, transparent )');
							}
							if (data.data.results && (data.data.results.files || data.data.results.db)) {
								if (data.data.results.files) {
									files = data.data.results.files;
									//console.dir(files);
									$results = '<table>';
									for (const [key, value] of Object.entries(files)) {
										$results += `<tr><td>${key}</td><td>${value}</td></tr>`;
									}
									$results += '</table>';
									$('#scan_results').html($results);
								}
							}
							if(remaining){
								mss_status_updater = setTimeout(mss_update_scan_status, 1000);
							}
						}
					} else {
						console.log('Updater got failure. Clearing interval. Please reload the page.');
					}
					if ((typeof data) != 'object') {}
					if (data.hasOwnProperty('success')) {} else {}
				},
				error: function (jqXHR, textStatus, errorThrown) {
					console.dir('eberror: updater error Data Begins');
					console.dir(jqXHR);
					console.dir(textStatus);
					console.dir(errorThrown);
					console.dir('cberror: updater error Data Ends');
				},
				complete: function (jqXHR_data, textStatus) {
					
				},
			});
		}
		</script>
		<?php
	}

	/**
	 * Init Scan
	 */
	function mss_trigger_scan() {
		if ( ! wp_doing_ajax() && ! wp_doing_cron() ) {
			malCure_Utils::flog( 'Not doing ajax and not doing cron.' );
			wp_die();
		}
		if ( wp_doing_ajax() ) {
			check_ajax_referer( 'mss_trigger_scan', 'mss_trigger_scan_nonce' );
			if ( ! current_user_can( malCure_Utils::$cap ) ) {
				malCure_Utils::flog( 'Not $this->cap.' );
				malCure_Utils::flog( wp_get_current_user() );
				malCure_Utils::flog( malCure_Utils::$cap );
				wp_die();
			}
		}
		malCure_Utils::do_maintenance();
		$already_running = malCure_Utils::get_setting( 'scan_id' );
		if ( $already_running ) {
			malCure_Utils::flog( 'ERROR: Scan ID ' . $already_running . ' is already running' );
			wp_send_json_error( 'ERROR: Scan ID ' . $already_running . ' is already running' );
		}

		$scan_id = time();
		malCure_Utils::update_setting( 'scan_id', $scan_id );

		$args     = array(
			'blocking' => false,
			'timeout'  => 0.01,
			'body'     => array(
				'action'        => 'mss_init_scan',
				'handshake_key' => wp_hash_password( $scan_id ),
			),
		);
		$response = wp_remote_post(
			admin_url( 'admin-ajax.php' ),
			$args
		);
		wp_send_json_success( $scan_id );
	}

	/**
	 * Step 2: Processes a full file + DB scan over remote requests
	 */
	function mss_init_scan_responder() {
		$start_time = microtime( true );
		$scan_id    = malCure_Utils::get_setting( 'scan_id' );
		if ( empty( $scan_id ) || empty( $_REQUEST['handshake_key'] ) || ! wp_check_password( $scan_id, $_REQUEST['handshake_key'] ) ) {
			malCure_Utils::flog( 'mss_init_scan_responder received invalid request:' );
			malCure_Utils::flog( 'empty( $scan_id ) ? :' . empty( $scan_id ) );
			malCure_Utils::flog( 'empty( $_REQUEST[\'handshake_key\'] ) ? :' . empty( $_REQUEST['handshake_key'] ) );
			malCure_Utils::flog( 'wp_check_password ? :' . wp_check_password( $scan_id, $_REQUEST['handshake_key'] ) );
			malCure_Utils::flog( $_REQUEST );
			wp_die();
		}

		$type = 'files';

		$cores   = malCure_Utils::num_cpus();
		$timeout = ini_get( 'max_execution_time' );
		if ( empty( $timeout ) ) {
			$timeout = 29;

		} else {
			$timeout = $timeout - 1;
		}
		if ( $type == 'files' ) {
			$start_time = microtime( true );
			$checksums  = $this->get_checksums();
			$files      = malCure_Utils::get_files();

			if ( ! empty( $files['files'] ) ) {
				$files = $files['files'];
				$total = count( $files );
				malCure_Utils::update_setting(
					'mc_scan_progress',
					array(
						'total'     => $total,
						'remaining' => $total,
					)
				);
			} else {
				malCure_Utils::flog( 'Scanner could not generate a list of files.' );
				throw new Exception( 'Scanner could not generate a list of files.' );
			}

			malCure_Utils::flog( 'INITIATING SCAN ID: ' . $scan_id );
			malCure_Utils::update_setting( 'scan_id', $scan_id );

			$site_url   = admin_url( 'admin-ajax.php' );
			$host       = parse_url( $site_url, PHP_URL_HOST );
			$local_url  = str_replace( $host, 'localhost', $site_url );
			$failed     = array();
			$batch_size = 11;
			$perf       = array();
			$segments   = 3;
			$files_done = 0;
			$wait       = 0;
			while ( $files ) {
				set_time_limit( $timeout );
				if ( count( $perf ) >= $segments ) {
					$perf            = array_splice( $perf, count( $perf ) - $segments, $segments );
					$time_factor     = ( $timeout / 2 ) - $time_taken;
					$time_factor_per = ( $time_factor * 100 ) / ( $timeout / 2 );
					$polarity        = ( ( min( $perf ) < 0 ) || $time_factor < 0 ) ? -1 : 1;
					$factor          = abs( $time_factor_per / ( abs( array_sum( $perf ) ) / 2 ) );
					$boost           = ( $polarity * ( ( $batch_size * $factor ) / 100 ) );
					$batch_size      = round( $batch_size + $boost );
					$batch_size      = min( $batch_size, 111 );
					$cpu             = @sys_getloadavg();
					if ( $cores && ! is_null( $cpu ) && ( ( $cpu[0] / $cores ) > 1.11 ) ) {
						malCure_Utils::flog( 'Max CPU:' . json_encode( $cpu ) );
						$batch_size = round( $batch_size / $segments );
					}
					$batch_size = max( $batch_size, 1 );

					if ( $batch_size == 1 ) { // if batch size continues to be 1, let's sleep 1 seconds on alternate requests
						$wait = ! $wait;
						if ( $wait ) {
							malCure_Utils::flog( 'Minimum batch size reached. Waiting for breath.' );
							sleep( 1 );
						}
					}
				}
				malCure_Utils::flog( "Batch Size: $batch_size" );
				$batch              = array_splice( $files, 0, $batch_size );
				$files_done        += count( $batch );
				$ts                 = microtime( true );
				$scan_request_start = microtime( 1 );
				$results            = $this->make_scan_request( $batch, 'file', $_REQUEST['handshake_key'], $local_url, $host, $timeout );

				$scan_request_end = microtime( 1 );
				$time_taken       = $scan_request_end - $scan_request_start;
				if ( $results ) {
					$perf[] = 1;
				} else {
					$failed = array_merge( $failed, $batch );
					malCure_Utils::flog( '!!!!!!!! FAILED !!!!!!!!' . count( $batch ) );
					malCure_Utils::flog( $results );
					$perf[] = -1;
				}
				$mc_scan_progress = array(
					'total'     => $total,
					'remaining' => $total - $files_done,
					'rate'      => ( $files_done / ( microtime( 1 ) - $start_time ) ),
				);
				malCure_Utils::update_setting( 'mc_scan_progress', $mc_scan_progress );
				if ( ! count( $files ) ) {
					// malCure_Utils::flog( 'Deleting $mc_scan_progress since no files remaining.' );
					malCure_Utils::flog( 'Check value of $mc_scan_progress since no files remaining.' );
					malCure_Utils::flog( malCure_Utils::get_setting( 'mc_scan_progress' ) );
					// malCure_Utils::delete_setting( 'mc_scan_progress' );
				}
				$te = microtime( true );
			}
			malCure_Utils::flog( 'Failure Count: ' . count( $failed ) );
			malCure_Utils::delete_setting( 'scan_id' );
			$end_time       = microtime( true );
			$execution_time = ( $end_time - $start_time );
			malCure_Utils::flog( 'Full Scan Completion Time: ' . human_time_diff( $start_time, $end_time ) );
			malCure_Utils::flog( 'COMPLETED SCAN ID: ' . $scan_id );
			wp_send_json_success(
				array(
					'checksums' => $checksums,
					'files'     => $files,
				)
			);
		}
		$end_time_files = microtime( true );
		malCure_Utils::flog( 'File Scan Completed: ' . human_time_diff( $start_time, $end_time_files ) );
		if ( $type = 'db' ) {
		}
		$end_time_db = microtime( true );
		malCure_Utils::flog( 'DB Scan Completed: ' . human_time_diff( $end_time_files, $end_time_db ) );
	}

	function get_failed_files( $files ) {
		$total            = count( $files );
		$mc_scan_progress = array(
			'total'     => $total,
			'remaining' => count( $files ),
		);
		$i                = 0;
		foreach ( $files as $file ) {
			$start_time = microtime( true );
			$end_time   = microtime( true );
			set_time_limit( 1 );
			if ( $this->fails_checksum( $file ) ) {
				$failed[] = $file;
			}
			$i++;
			if ( $i % 100 == 0 ) {
				$mc_scan_progress = array(
					'total'     => $total,
					'remaining' => $total - $i,
				);
				malCure_Utils::update_setting(
					'mc_scan_progress',
					$mc_scan_progress
				);
			}
			$execution_time = ( $end_time - $start_time );
			malCure_Utils::flog( round( $execution_time ) . "\t" . str_pad( filesize( $file ), 8 ) . "\t" . $file, false, false );
		}
		return $failed;
	}

	/**
	 * Function to request a singular remote scan
	 *
	 * @param [type] $data
	 * @param [type] $type
	 * @return void
	 */
	function make_scan_request( $data, $type, $handshake_key, $local_url = '', $host = '', $timeout = 5 ) {
		$start_time = microtime( true );
		$args       = array(
			'timeout'  => $timeout,
			'blocking' => true,
			'body'     => array(
				'action'        => 'mss_scan_request',
				'data'          => $data,
				'handshake_key' => $handshake_key,
				'type'          => $type,
			),
		);
		if ( $host ) {
			$headers         = array(
				'Host' => $host,
			);
			$args['headers'] = $headers;
		}
		if ( $host ) {
			$url = $local_url;
			$url = str_replace( 'https', 'http', $url );
		} else {
			$url = admin_url( 'admin-ajax.php' );
		}

		$response = wp_remote_post( $url, $args );
		//malCure_Utils::flog( $response );
		if ( wp_remote_retrieve_response_code( $response ) != 200 ) {
			return;
		}
		return true;

		// $body = wp_remote_retrieve_body( $response );
		// if ( empty( $body ) || is_null( json_decode( $body ) ) ) {
		// return;
		// }
		// $results = json_decode( $body, 1 );
		// if ( ! empty( $results['success'] ) ) {
		// return $results;
		// }
		$end_time = microtime( true );
	}

	/**
	 * Final end-point, Responds to ajax scan request, scans synchronously, prone to hang
	 *
	 * @return void
	 */
	function scan_responder() {
		$scan_id = malCure_Utils::get_setting( 'scan_id' );
		if ( empty( $scan_id ) || empty( $_REQUEST['handshake_key'] ) || ! wp_check_password( $scan_id, $_REQUEST['handshake_key'] ) ) {
			malCure_Utils::flog( 'DYING: ' . __FUNCTION__ );
			malCure_Utils::flog( '$scan_id: ' . $scan_id );
			malCure_Utils::flog( 'handshake_key: ' . $_REQUEST['handshake_key'] );
			malCure_Utils::flog( 'wp_check_password: ' . wp_check_password( $scan_id, $_REQUEST['handshake_key'] ) );
			wp_die();
		}
		$data = $_REQUEST['data'];
		$type = $_REQUEST['type'];
		$temp = array_values( $data );
		$temp = array_splice( $temp, count( $temp ) - 1, 1 );
		malCure_Utils::flog( "\t\tSCANNING: " . $temp[0] . "\t RECEIVED " . count( array_values( $data ) ) . ' files.' );

		if ( $type == 'file' ) {
			$files   = $data;
			$results = array();
			foreach ( $files as $file ) {
				if ( preg_match( '/6_chris/', $file ) ) { // || preg_match( '/plugins/', $file ) || preg_match( '/wp\-content/', $file )
					//continue;
				}
				if ( $this->fails_checksum( $file ) ) {
					$scan = $this->scan_file( $file );
					if ( $scan ) {
						if ( ! empty( $scan['id'] ) ) {
							$results[ $file ] = $scan['id'];
						} else {
						}
					} else {
					}
				}
			}
			$this->update_scan_status( $results, $scan_id, 'files' );
		}
		if ( ( $type == 'db' ) ) {
		}
		wp_send_json_success();
	}

	function update_scan_status( $data, $scan_id, $type ) {
		if ( ! $scan_id ) {
			die();
		}
		$scan_id = strval( $scan_id );
		$scans   = malCure_Utils::get_option( 'MSS_scans' );

		if ( empty( $scans ) ) {
			$scans = array();
		}
		if ( empty( $scans[ $scan_id ] ) ) {
			$scans[ $scan_id ] = array( $type => array() );
		}

		$scans[ $scan_id ][ $type ] = array_merge( $scans[ $scan_id ][ $type ], $data );

		update_option( 'MSS_scans', $scans );
	}

	/**
	 * Send status of the scan
	 */
	function mss_scan_status_handler() {
		//malCure_Utils::fetch_checksums();
		$progress = malCure_Utils::get_setting( 'mc_scan_progress' );
		$complete = malCure_Utils::get_setting( 'scan_id' );
		$scan     = malCure_Utils::get_option( 'MSS_scans' );
		if ( ! $scan ) {
			wp_send_json_error();
		}
		$scan = array_slice( $scan, count( $scan ) - 1, 1, true );
		if ( ! $scan ) {
			wp_send_json_error();
		}
		$complete             = empty( $complete ) ? true : false;
		$progress['started']  = array_keys( $scan )[0];
		$progress['results']  = array_values( $scan )[0];
		$progress['complete'] = $complete;
		$progress['now']      = time();
		wp_send_json_success( $progress );
	}

	function submenu_page() {
		add_submenu_page(
			'_mss',
			'malCure WordPress Malware Scanner',
			'Malware Scanner',
			MSS_GOD,
			'scanner_mss',
			array( $this, 'scanner_mss_page' ),
			null
		);
	}

	function get_checksums() {
		return malCure_Utils::fetch_checksums();
	}

	function fails_checksum( $local_file ) {
		$checksums = $this->get_checksums();
		$expected  = @md5_file( $local_file );
		if ( ! $expected ) {
			malCure_Utils::flog( 'Failed to generate checksum for ' . $local_file );
			return 1;
		}
		$match_path = malCure_Utils::normalize_path( $local_file );
		if ( array_key_exists( $match_path, $checksums ) ) {
			if ( is_array( $checksums[ $match_path ] ) ) {
				if ( ! in_array( $expected, $checksums[ $match_path ] ) ) {
					return 1;
				} else {
					return;
				}
			} else {
				if ( $checksums[ $match_path ] != $expected ) {
					return 1;
				} else {
					return;
				}
			}
		} else {
			return 1;
		}
	}

}

malCure_Malware_Scanner::get_instance();
